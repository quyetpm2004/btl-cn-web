<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω B·∫£o Tr√¨ Thi·∫øt B·ªã</title>
    <script
      type="text/javascript"
      nonce="551699995f414289ac7b396e297"
      src="//local.adguard.org?ts=1764159925304&amp;type=content-script&amp;dmn=bv6capgmnb942ny2.canva-hosted-embed.com&amp;url=https%3A%2F%2Fbv6capgmnb942ny2.canva-hosted-embed.com%2Fcodelet%2FAAEAEGJ2NmNhcGdtbmI5NDJueTIAAAAAAZrFVBUa-eukKrXcr82ZyYeJpmGN6Woukt86Ix1Bqrrqp-uohhE%2Findex.html&amp;app=chrome.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"
    ></script>
    <script
      type="text/javascript"
      nonce="551699995f414289ac7b396e297"
      src="//local.adguard.org?ts=1764159925304&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"
    ></script>
    <script src="/_sdk/data_sdk.js"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        box-sizing: border-box;
      }

      * {
        box-sizing: border-box;
      }

      .priority-urgent {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .priority-high {
        background-color: #fed7aa;
        color: #9a3412;
      }

      .priority-normal {
        background-color: #dbeafe;
        color: #1e40af;
      }

      .priority-low {
        background-color: #e0e7ff;
        color: #3730a3;
      }

      .status-pending {
        background-color: #fef3c7;
        color: #92400e;
      }

      .status-in-progress {
        background-color: #dbeafe;
        color: #1e40af;
      }

      .status-completed {
        background-color: #d1fae5;
        color: #065f46;
      }

      .image-preview {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
      }

      .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-image {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        line-height: 1;
      }

      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }

      .modal-backdrop.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 600px;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 2000;
        animation: slideIn 0.3s ease-out;
      }

      .toast.active {
        display: block;
      }

      .toast.error {
        background: #ef4444;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .star-rating {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .star {
        font-size: 32px;
        cursor: pointer;
        transition: all 0.2s;
        color: #d1d5db;
      }

      .star:hover,
      .star.active {
        color: #fbbf24;
        transform: scale(1.1);
      }

      .feedback-card {
        background: #f9fafb;
        border-left: 4px solid #667eea;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
      }

      @media (max-width: 640px) {
        .modal-content {
          max-height: 85%;
        }
      }
    </style>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
  </head>
  <body>
    <div
      class="app-wrapper"
      style="
        width: 100%;
        min-height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      "
    >
      <div
        style="width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px"
      >
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 32px">
          <h1
            id="page-title"
            style="
              font-size: 32px;
              font-weight: bold;
              color: white;
              margin-bottom: 8px;
            "
          >
            Qu·∫£n L√Ω B·∫£o Tr√¨
          </h1>
          <p
            id="page-subtitle"
            style="font-size: 16px; color: rgba(255, 255, 255, 0.9)"
          >
            Theo d√µi y√™u c·∫ßu b·∫£o tr√¨ c·ªßa b·∫°n
          </p>
        </div>
        <!-- Action Button -->
        <div
          style="margin-bottom: 24px; display: flex; justify-content: center"
        >
          <button
            id="new-request-btn"
            style="
              background: white;
              color: #667eea;
              padding: 14px 28px;
              border-radius: 8px;
              font-weight: 600;
              border: none;
              cursor: pointer;
              font-size: 16px;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              transition: all 0.2s;
            "
          >
            + <span id="new-request-text">T·∫°o Y√™u C·∫ßu M·ªõi</span>
          </button>
        </div>
        <!-- Filter Tabs -->
        <div
          style="
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
          "
        >
          <button
            class="filter-tab active"
            data-filter="all"
            style="
              flex: 1;
              min-width: 100px;
              padding: 12px 16px;
              border: none;
              background: #667eea;
              color: white;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
          >
            T·∫•t c·∫£
          </button>
          <button
            class="filter-tab"
            data-filter="pending"
            style="
              flex: 1;
              min-width: 100px;
              padding: 12px 16px;
              border: none;
              background: transparent;
              color: #667eea;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
          >
            Ch·ªù x·ª≠ l√Ω
          </button>
          <button
            class="filter-tab"
            data-filter="in-progress"
            style="
              flex: 1;
              min-width: 100px;
              padding: 12px 16px;
              border: none;
              background: transparent;
              color: #667eea;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
          >
            ƒêang x·ª≠ l√Ω
          </button>
          <button
            class="filter-tab"
            data-filter="completed"
            style="
              flex: 1;
              min-width: 100px;
              padding: 12px 16px;
              border: none;
              background: transparent;
              color: #667eea;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
          >
            Ho√†n th√†nh
          </button>
        </div>
        <!-- Requests List -->
        <div
          id="requests-list"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
          "
        >
          <!-- Requests will be rendered here -->
        </div>
        <!-- Empty State -->
        <div
          id="empty-state"
          style="
            display: none;
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
          "
        >
          <div style="font-size: 64px; margin-bottom: 16px">üìã</div>
          <h3
            style="
              font-size: 20px;
              font-weight: 600;
              color: #374151;
              margin-bottom: 8px;
            "
          >
            Ch∆∞a c√≥ y√™u c·∫ßu n√†o
          </h3>
          <p style="color: #6b7280; font-size: 14px">
            T·∫°o y√™u c·∫ßu b·∫£o tr√¨ ƒë·∫ßu ti√™n c·ªßa b·∫°n!
          </p>
        </div>
      </div>
    </div>
    <!-- Modal Form -->
    <div id="modal-backdrop" class="modal-backdrop">
      <div class="modal-content">
        <div style="padding: 24px; border-bottom: 1px solid #e5e7eb">
          <h2 style="font-size: 24px; font-weight: 700; color: #111827">
            T·∫°o Y√™u C·∫ßu B·∫£o Tr√¨
          </h2>
        </div>
        <form id="request-form" style="padding: 24px">
          <!-- Device Selection -->
          <div style="margin-bottom: 20px">
            <label
              for="device"
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                font-size: 14px;
              "
              >Thi·∫øt b·ªã c·∫ßn b·∫£o tr√¨ *</label
            >
            <select
              id="device"
              required
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 14px;
                color: #111827;
                background: white;
              "
            >
              <option value="">Ch·ªçn thi·∫øt b·ªã...</option>
              <option value="ƒêi·ªÅu h√≤a">ƒêi·ªÅu h√≤a</option>
              <option value="Thang m√°y">Thang m√°y</option>
              <option value="H·ªá th·ªëng n∆∞·ªõc">H·ªá th·ªëng n∆∞·ªõc</option>
              <option value="H·ªá th·ªëng ƒëi·ªán">H·ªá th·ªëng ƒëi·ªán</option>
              <option value="C·ª≠a ra v√†o">C·ª≠a ra v√†o</option>
              <option value="C·ª≠a s·ªï">C·ª≠a s·ªï</option>
              <option value="Thi·∫øt b·ªã v·ªá sinh">Thi·∫øt b·ªã v·ªá sinh</option>
              <option value="Kh√°c">Kh√°c</option>
            </select>
          </div>
          <!-- Priority -->
          <div style="margin-bottom: 20px">
            <label
              for="priority"
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                font-size: 14px;
              "
              >M·ª©c ƒë·ªô ∆∞u ti√™n *</label
            >
            <select
              id="priority"
              required
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 14px;
                color: #111827;
                background: white;
              "
            >
              <option value="normal">B√¨nh th∆∞·ªùng</option>
              <option value="high">Cao</option>
              <option value="urgent">Kh·∫©n c·∫•p</option>
              <option value="low">Th·∫•p</option>
            </select>
          </div>
          <!-- Note -->
          <div style="margin-bottom: 20px">
            <label
              for="note"
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                font-size: 14px;
              "
              >Ghi ch√∫ *</label
            >
            <textarea
              id="note"
              required
              rows="4"
              placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ v·∫•n ƒë·ªÅ..."
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 14px;
                color: #111827;
                resize: vertical;
              "
            ></textarea>
          </div>
          <!-- Images -->
          <div style="margin-bottom: 20px">
            <label
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                font-size: 14px;
              "
              >H√¨nh ·∫£nh (T·ªëi ƒëa 5)</label
            >
            <input
              type="file"
              id="image-input"
              accept="image*/"
              multiple
              style="display: none"
            />
            <button
              type="button"
              id="upload-btn"
              style="
                width: 100%;
                padding: 12px;
                border: 2px dashed #d1d5db;
                border-radius: 8px;
                background: #f9fafb;
                color: #6b7280;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.2s;
              "
            >
              üì∑ Ch·ªçn h√¨nh ·∫£nh
            </button>
            <div
              id="image-previews"
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                margin-top: 12px;
              "
            >
              <!-- Image previews will be shown here -->
            </div>
          </div>
          <!-- Actions -->
          <div style="display: flex; gap: 12px; margin-top: 24px">
            <button
              type="button"
              id="cancel-btn"
              style="
                flex: 1;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                background: white;
                color: #374151;
                font-weight: 600;
                cursor: pointer;
                font-size: 14px;
              "
            >
              <span id="cancel-text">H·ªßy</span>
            </button>
            <button
              type="submit"
              id="submit-btn"
              style="
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                background: #667eea;
                color: white;
                font-weight: 600;
                cursor: pointer;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
              "
            >
              <span id="submit-text">G·ª≠i Y√™u C·∫ßu</span>
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal-backdrop">
      <div class="modal-content">
        <div style="padding: 24px; border-bottom: 1px solid #e5e7eb">
          <h2 style="font-size: 24px; font-weight: 700; color: #111827">
            ƒê√°nh Gi√° D·ªãch V·ª•
          </h2>
          <p style="color: #6b7280; font-size: 14px; margin-top: 4px">
            Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ d·ªãch v·ª• b·∫£o tr√¨
          </p>
        </div>
        <form id="feedback-form" style="padding: 24px">
          <input type="hidden" id="feedback-request-id" />
          <!-- Rating -->
          <div style="margin-bottom: 24px">
            <label
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 12px;
                font-size: 14px;
                text-align: center;
              "
              >M·ª©c ƒë·ªô h√†i l√≤ng *</label
            >
            <div class="star-rating" id="star-rating">
              <span class="star" data-rating="1">‚òÖ</span>
              <span class="star" data-rating="2">‚òÖ</span>
              <span class="star" data-rating="3">‚òÖ</span>
              <span class="star" data-rating="4">‚òÖ</span>
              <span class="star" data-rating="5">‚òÖ</span>
            </div>
            <p
              id="rating-text"
              style="
                text-align: center;
                color: #6b7280;
                font-size: 14px;
                margin-top: 8px;
              "
            >
              Ch·ªçn s·ªë sao ƒë√°nh gi√°
            </p>
          </div>
          <!-- Feedback -->
          <div style="margin-bottom: 20px">
            <label
              for="feedback-note"
              style="
                display: block;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                font-size: 14px;
              "
              >Nh·∫≠n x√©t c·ªßa b·∫°n *</label
            >
            <textarea
              id="feedback-note"
              required
              rows="4"
              placeholder="Chia s·∫ª chi ti·∫øt v·ªÅ ch·∫•t l∆∞·ª£ng d·ªãch v·ª•, th√°i ƒë·ªô nh√¢n vi√™n, th·ªùi gian x·ª≠ l√Ω..."
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                font-size: 14px;
                color: #111827;
                resize: vertical;
              "
            ></textarea>
          </div>
          <!-- Actions -->
          <div style="display: flex; gap: 12px; margin-top: 24px">
            <button
              type="button"
              id="feedback-cancel-btn"
              style="
                flex: 1;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                background: white;
                color: #374151;
                font-weight: 600;
                cursor: pointer;
                font-size: 14px;
              "
            >
              H·ªßy
            </button>
            <button
              type="submit"
              id="feedback-submit-btn"
              style="
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                background: #667eea;
                color: white;
                font-weight: 600;
                cursor: pointer;
                font-size: 14px;
              "
            >
              G·ª≠i ƒê√°nh Gi√°
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- Toast Notification -->
    <div id="toast"></div>
    <script>
      const defaultConfig = {
        page_title: "Qu·∫£n L√Ω B·∫£o Tr√¨",
        page_subtitle: "Theo d√µi y√™u c·∫ßu b·∫£o tr√¨ c·ªßa b·∫°n",
        new_request_button: "T·∫°o Y√™u C·∫ßu M·ªõi",
        submit_button: "G·ª≠i Y√™u C·∫ßu",
        cancel_button: "H·ªßy",
        background_color: "#667eea",
        surface_color: "#ffffff",
        text_color: "#111827",
        primary_action_color: "#667eea",
        secondary_action_color: "#6B7280",
        font_family: "system-ui, -apple-system, sans-serif",
        font_size: 16,
      };

      let currentFilter = "all";
      let selectedImages = [];
      let allRequests = [];
      let selectedRating = 0;

      const priorityLabels = {
        urgent: "Kh·∫©n c·∫•p",
        high: "Cao",
        normal: "B√¨nh th∆∞·ªùng",
        low: "Th·∫•p",
      };

      const statusLabels = {
        pending: "Ch·ªù x·ª≠ l√Ω",
        "in-progress": "ƒêang x·ª≠ l√Ω",
        completed: "Ho√†n th√†nh",
      };

      const ratingTexts = {
        1: "R·∫•t kh√¥ng h√†i l√≤ng",
        2: "Kh√¥ng h√†i l√≤ng",
        3: "Trung b√¨nh",
        4: "H√†i l√≤ng",
        5: "R·∫•t h√†i l√≤ng",
      };

      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = isError ? "toast error active" : "toast active";
        setTimeout(() => {
          toast.className = isError ? "toast error" : "toast";
        }, 3000);
      }

      function openFeedbackModal(requestId) {
        document.getElementById("feedback-request-id").value = requestId;
        document.getElementById("feedback-modal").classList.add("active");
        selectedRating = 0;
        document
          .querySelectorAll(".star")
          .forEach((star) => star.classList.remove("active"));
        document.getElementById("rating-text").textContent =
          "Ch·ªçn s·ªë sao ƒë√°nh gi√°";
        document.getElementById("feedback-note").value = "";
      }

      function renderRequests(requests) {
        const container = document.getElementById("requests-list");
        const emptyState = document.getElementById("empty-state");

        const filteredRequests =
          currentFilter === "all"
            ? requests
            : requests.filter((r) => r.status === currentFilter);

        if (filteredRequests.length === 0) {
          container.style.display = "none";
          emptyState.style.display = "block";
          return;
        }

        container.style.display = "grid";
        emptyState.style.display = "none";

        const sortedRequests = [...filteredRequests].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );

        container.innerHTML = sortedRequests
          .map((request) => {
            const images = request.images
              ? request.images.split(",").filter(Boolean)
              : [];
            const date = new Date(request.createdAt);
            const formattedDate = date.toLocaleDateString("vi-VN", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            const hasFeedback = request.feedback && request.rating;
            const stars = hasFeedback
              ? "‚òÖ".repeat(request.rating) + "‚òÜ".repeat(5 - request.rating)
              : "";

            return `
          <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: all 0.2s;">
            <div style="padding: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                  <span class="priority-${
                    request.priority
                  }" style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 8px;">
                    ${priorityLabels[request.priority]}
                  </span>
                  <h3 style="font-size: 18px; font-weight: 700; color: #111827; margin-bottom: 4px;">${
                    request.device
                  }</h3>
                </div>
              </div>
              
              <p style="color: #6B7280; font-size: 14px; margin-bottom: 12px; line-height: 1.5;">${
                request.note
              }</p>
              
              ${
                images.length > 0
                  ? `
                <div style="display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto;">
                  ${images
                    .map(
                      (img) => `
                    <div style="min-width: 60px; height: 60px; border-radius: 8px; overflow: hidden; background: #F3F4F6;">
                      <img src="${img}" alt="·∫¢nh b·∫£o tr√¨" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src=''; this.alt='L·ªói t·∫£i ·∫£nh'; this.style.display='none';">
                    </div>
                  `
                    )
                    .join("")}
                </div>
              `
                  : ""
              }

              ${
                hasFeedback
                  ? `
                <div class="feedback-card">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="color: #FBBF24; font-size: 16px;">${stars}</span>
                    <span style="font-size: 12px; color: #6B7280; font-weight: 600;">${
                      ratingTexts[request.rating]
                    }</span>
                  </div>
                  <p style="font-size: 13px; color: #374151; line-height: 1.4;">"${
                    request.feedback
                  }"</p>
                </div>
              `
                  : ""
              }
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #E5E7EB; margin-top: 12px;">
                <span style="font-size: 12px; color: #9CA3AF;">${formattedDate}</span>
                <span class="status-${
                  request.status
                }" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                  ${statusLabels[request.status]}
                </span>
              </div>

              ${
                request.status === "completed" && !hasFeedback
                  ? `
                <button onclick="openFeedbackModal('${request.id}')" style="width: 100%; margin-top: 12px; padding: 10px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                  ‚≠ê ƒê√°nh Gi√° D·ªãch V·ª•
                </button>
              `
                  : ""
              }
            </div>
          </div>
        `;
          })
          .join("");
      }

      function handleImageSelect(event) {
        const files = Array.from(event.target.files);
        const remainingSlots = 5 - selectedImages.length;

        if (files.length > remainingSlots) {
          showToast(
            `Ch·ªâ c√≥ th·ªÉ th√™m ${remainingSlots} ·∫£nh n·ªØa (T·ªëi ƒëa 5 ·∫£nh)`,
            true
          );
          return;
        }

        files.forEach((file) => {
          if (selectedImages.length < 5) {
            const reader = new FileReader();
            reader.onload = (e) => {
              selectedImages.push(e.target.result);
              renderImagePreviews();
            };
            reader.readAsDataURL(file);
          }
        });

        event.target.value = "";
      }

      function renderImagePreviews() {
        const container = document.getElementById("image-previews");
        container.innerHTML = selectedImages
          .map(
            (img, index) => `
        <div class="image-preview">
          <img src="${img}" alt="Preview ${
              index + 1
            }" onerror="this.src=''; this.alt='L·ªói t·∫£i ·∫£nh';">
          <button type="button" class="remove-image" onclick="removeImage(${index})">√ó</button>
        </div>
      `
          )
          .join("");
      }

      function removeImage(index) {
        selectedImages.splice(index, 1);
        renderImagePreviews();
      }

      async function handleSubmit(event) {
        event.preventDefault();

        if (allRequests.length >= 999) {
          showToast(
            "ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 y√™u c·∫ßu. Vui l√≤ng x√≥a b·ªõt y√™u c·∫ßu c≈©!",
            true
          );
          return;
        }

        const submitBtn = document.getElementById("submit-btn");
        const submitText = document.getElementById("submit-text");
        const originalText = submitText.textContent;

        submitBtn.disabled = true;
        submitText.textContent = "ƒêang g·ª≠i...";
        submitBtn.style.opacity = "0.7";

        const formData = {
          id: Date.now().toString(),
          device: document.getElementById("device").value,
          priority: document.getElementById("priority").value,
          note: document.getElementById("note").value,
          images: selectedImages.join(","),
          status: "pending",
          createdAt: new Date().toISOString(),
          completedAt: "",
          feedback: "",
          rating: 0,
        };

        const result = await window.dataSdk.create(formData);

        if (result.isOk) {
          showToast("Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!");
          document.getElementById("modal-backdrop").classList.remove("active");
          document.getElementById("request-form").reset();
          selectedImages = [];
          renderImagePreviews();
        } else {
          showToast("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!", true);
        }

        submitBtn.disabled = false;
        submitText.textContent = originalText;
        submitBtn.style.opacity = "1";
      }

      async function handleFeedbackSubmit(event) {
        event.preventDefault();

        if (selectedRating === 0) {
          showToast("Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!", true);
          return;
        }

        const submitBtn = document.getElementById("feedback-submit-btn");
        submitBtn.disabled = true;
        submitBtn.textContent = "ƒêang g·ª≠i...";
        submitBtn.style.opacity = "0.7";

        const requestId = document.getElementById("feedback-request-id").value;
        const feedbackNote = document.getElementById("feedback-note").value;

        const request = allRequests.find((r) => r.id === requestId);
        if (request) {
          const updatedRequest = {
            ...request,
            feedback: feedbackNote,
            rating: selectedRating,
          };

          const result = await window.dataSdk.update(updatedRequest);

          if (result.isOk) {
            showToast("C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!");
            document
              .getElementById("feedback-modal")
              .classList.remove("active");
            document.getElementById("feedback-form").reset();
            selectedRating = 0;
          } else {
            showToast("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!", true);
          }
        }

        submitBtn.disabled = false;
        submitBtn.textContent = "G·ª≠i ƒê√°nh Gi√°";
        submitBtn.style.opacity = "1";
      }

      async function onConfigChange(config) {
        const customFont = config.font_family || defaultConfig.font_family;
        const baseFontStack = "system-ui, -apple-system, sans-serif";
        const fontFamily = `${customFont}, ${baseFontStack}`;
        const baseSize = config.font_size || defaultConfig.font_size;

        const backgroundColor =
          config.background_color || defaultConfig.background_color;
        const surfaceColor =
          config.surface_color || defaultConfig.surface_color;
        const textColor = config.text_color || defaultConfig.text_color;
        const primaryColor =
          config.primary_action_color || defaultConfig.primary_action_color;
        const secondaryColor =
          config.secondary_action_color || defaultConfig.secondary_action_color;

        document.querySelector(
          ".app-wrapper"
        ).style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${backgroundColor}dd 100%)`;

        document.getElementById("page-title").textContent =
          config.page_title || defaultConfig.page_title;
        document.getElementById("page-title").style.fontFamily = fontFamily;
        document.getElementById("page-title").style.fontSize = `${
          baseSize * 2
        }px`;
        document.getElementById("page-title").style.color = surfaceColor;

        document.getElementById("page-subtitle").textContent =
          config.page_subtitle || defaultConfig.page_subtitle;
        document.getElementById("page-subtitle").style.fontFamily = fontFamily;
        document.getElementById(
          "page-subtitle"
        ).style.fontSize = `${baseSize}px`;
        document.getElementById("page-subtitle").style.color = surfaceColor;

        document.getElementById("new-request-text").textContent =
          config.new_request_button || defaultConfig.new_request_button;
        document.getElementById("new-request-btn").style.fontFamily =
          fontFamily;
        document.getElementById(
          "new-request-btn"
        ).style.fontSize = `${baseSize}px`;
        document.getElementById("new-request-btn").style.background =
          surfaceColor;
        document.getElementById("new-request-btn").style.color = primaryColor;

        document.getElementById("submit-text").textContent =
          config.submit_button || defaultConfig.submit_button;
        document.getElementById("submit-btn").style.fontFamily = fontFamily;
        document.getElementById("submit-btn").style.fontSize = `${
          baseSize * 0.875
        }px`;
        document.getElementById("submit-btn").style.background = primaryColor;

        document.getElementById("cancel-text").textContent =
          config.cancel_button || defaultConfig.cancel_button;
        document.getElementById("cancel-btn").style.fontFamily = fontFamily;
        document.getElementById("cancel-btn").style.fontSize = `${
          baseSize * 0.875
        }px`;
        document.getElementById("cancel-btn").style.color = secondaryColor;

        const allText = document.querySelectorAll("body *");
        allText.forEach((el) => {
          if (!el.style.fontFamily) {
            el.style.fontFamily = fontFamily;
          }
        });
      }

      const dataHandler = {
        onDataChanged(data) {
          allRequests = data;
          renderRequests(data);
        },
      };

      let hasInitialized = false;

      document.addEventListener("DOMContentLoaded", async () => {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          showToast("Kh√¥ng th·ªÉ k·∫øt n·ªëi. Vui l√≤ng t·∫£i l·∫°i trang!", true);
          return;
        }

        // Add sample data only once when no data exists
        if (!hasInitialized && allRequests.length === 0) {
          hasInitialized = true;

          const sampleRequests = [
            {
              id: "1",
              device: "ƒêi·ªÅu h√≤a",
              priority: "urgent",
              note: "ƒêi·ªÅu h√≤a ph√≤ng kh√°ch kh√¥ng ho·∫°t ƒë·ªông, th·ªïi h∆°i n√≥ng thay v√¨ l·∫°nh. C·∫ßn s·ª≠a ch·ªØa g·∫•p v√¨ tr·ªùi ƒëang n√≥ng.",
              images: "",
              status: "pending",
              createdAt: new Date(
                Date.now() - 2 * 60 * 60 * 1000
              ).toISOString(),
              completedAt: "",
              feedback: "",
              rating: 0,
            },
            {
              id: "2",
              device: "H·ªá th·ªëng n∆∞·ªõc",
              priority: "high",
              note: "V√≤i n∆∞·ªõc b·ªìn r·ª≠a b√°t b·ªã r√≤ r·ªâ, n∆∞·ªõc ch·∫£y li√™n t·ª•c ngay c·∫£ khi ƒë√£ v·∫∑n ch·∫∑t. L√£ng ph√≠ n∆∞·ªõc.",
              images: "",
              status: "in-progress",
              createdAt: new Date(
                Date.now() - 1 * 24 * 60 * 60 * 1000
              ).toISOString(),
              completedAt: "",
              feedback: "",
              rating: 0,
            },
            {
              id: "3",
              device: "C·ª≠a ra v√†o",
              priority: "normal",
              note: "C·ª≠a ch√≠nh c√≥ ti·∫øng k√™u c√≥t k√©t khi ƒë√≥ng m·ªü. C·∫ßn tra d·∫ßu ho·∫∑c ƒëi·ªÅu ch·ªânh b·∫£n l·ªÅ.",
              images: "",
              status: "completed",
              createdAt: new Date(
                Date.now() - 3 * 24 * 60 * 60 * 1000
              ).toISOString(),
              completedAt: new Date(
                Date.now() - 2 * 24 * 60 * 60 * 1000
              ).toISOString(),
              feedback:
                "Nh√¢n vi√™n ƒë·∫øn r·∫•t nhanh v√† x·ª≠ l√Ω t·ªët. C·ª≠a kh√¥ng c√≤n k√™u n·ªØa. R·∫•t h√†i l√≤ng v·ªõi d·ªãch v·ª•!",
              rating: 5,
            },
            {
              id: "4",
              device: "H·ªá th·ªëng ƒëi·ªán",
              priority: "normal",
              note: "ƒê√®n h√†nh lang ngo√†i h√†nh lang t·∫ßng 5 b·ªã h·ªèng, kh√¥ng s√°ng. ·∫¢nh h∆∞·ªüng ƒë·∫øn an to√†n di chuy·ªÉn ban ƒë√™m.",
              images: "",
              status: "pending",
              createdAt: new Date(
                Date.now() - 5 * 60 * 60 * 1000
              ).toISOString(),
              completedAt: "",
              feedback: "",
              rating: 0,
            },
            {
              id: "5",
              device: "Thi·∫øt b·ªã v·ªá sinh",
              priority: "high",
              note: "B·ªìn c·∫ßu ph√≤ng t·∫Øm b·ªã t·∫Øc, x·∫£ n∆∞·ªõc kh√¥ng xu·ªëng. C·∫ßn th√¥ng t·∫Øc kh·∫©n c·∫•p.",
              images: "",
              status: "in-progress",
              createdAt: new Date(
                Date.now() - 6 * 60 * 60 * 1000
              ).toISOString(),
              completedAt: "",
              feedback: "",
              rating: 0,
            },
          ];

          for (const request of sampleRequests) {
            await window.dataSdk.create(request);
          }
        }

        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () =>
                    config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    config.background_color = value;
                    window.elementSdk.setConfig({ background_color: value });
                  },
                },
                {
                  get: () =>
                    config.surface_color || defaultConfig.surface_color,
                  set: (value) => {
                    config.surface_color = value;
                    window.elementSdk.setConfig({ surface_color: value });
                  },
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  },
                },
                {
                  get: () =>
                    config.primary_action_color ||
                    defaultConfig.primary_action_color,
                  set: (value) => {
                    config.primary_action_color = value;
                    window.elementSdk.setConfig({
                      primary_action_color: value,
                    });
                  },
                },
                {
                  get: () =>
                    config.secondary_action_color ||
                    defaultConfig.secondary_action_color,
                  set: (value) => {
                    config.secondary_action_color = value;
                    window.elementSdk.setConfig({
                      secondary_action_color: value,
                    });
                  },
                },
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                  config.font_family = value;
                  window.elementSdk.setConfig({ font_family: value });
                },
              },
              fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                  config.font_size = value;
                  window.elementSdk.setConfig({ font_size: value });
                },
              },
            }),
            mapToEditPanelValues: (config) =>
              new Map([
                ["page_title", config.page_title || defaultConfig.page_title],
                [
                  "page_subtitle",
                  config.page_subtitle || defaultConfig.page_subtitle,
                ],
                [
                  "new_request_button",
                  config.new_request_button || defaultConfig.new_request_button,
                ],
                [
                  "submit_button",
                  config.submit_button || defaultConfig.submit_button,
                ],
                [
                  "cancel_button",
                  config.cancel_button || defaultConfig.cancel_button,
                ],
              ]),
          });
        }

        // Star rating interactions
        document.querySelectorAll(".star").forEach((star) => {
          star.addEventListener("click", () => {
            selectedRating = parseInt(star.dataset.rating);
            document.querySelectorAll(".star").forEach((s, index) => {
              if (index < selectedRating) {
                s.classList.add("active");
              } else {
                s.classList.remove("active");
              }
            });
            document.getElementById("rating-text").textContent =
              ratingTexts[selectedRating];
          });

          star.addEventListener("mouseenter", () => {
            const rating = parseInt(star.dataset.rating);
            document.querySelectorAll(".star").forEach((s, index) => {
              if (index < rating) {
                s.style.color = "#FBBF24";
              } else {
                s.style.color = "#D1D5DB";
              }
            });
          });
        });

        document
          .getElementById("star-rating")
          .addEventListener("mouseleave", () => {
            document.querySelectorAll(".star").forEach((s, index) => {
              if (index < selectedRating) {
                s.style.color = "#FBBF24";
              } else {
                s.style.color = "#D1D5DB";
              }
            });
          });

        document
          .getElementById("new-request-btn")
          .addEventListener("click", () => {
            document.getElementById("modal-backdrop").classList.add("active");
          });

        document.getElementById("cancel-btn").addEventListener("click", () => {
          document.getElementById("modal-backdrop").classList.remove("active");
          document.getElementById("request-form").reset();
          selectedImages = [];
          renderImagePreviews();
        });

        document
          .getElementById("feedback-cancel-btn")
          .addEventListener("click", () => {
            document
              .getElementById("feedback-modal")
              .classList.remove("active");
            document.getElementById("feedback-form").reset();
            selectedRating = 0;
          });

        document
          .getElementById("modal-backdrop")
          .addEventListener("click", (e) => {
            if (e.target === document.getElementById("modal-backdrop")) {
              document
                .getElementById("modal-backdrop")
                .classList.remove("active");
              document.getElementById("request-form").reset();
              selectedImages = [];
              renderImagePreviews();
            }
          });

        document
          .getElementById("feedback-modal")
          .addEventListener("click", (e) => {
            if (e.target === document.getElementById("feedback-modal")) {
              document
                .getElementById("feedback-modal")
                .classList.remove("active");
              document.getElementById("feedback-form").reset();
              selectedRating = 0;
            }
          });

        document.getElementById("upload-btn").addEventListener("click", () => {
          document.getElementById("image-input").click();
        });

        document
          .getElementById("image-input")
          .addEventListener("change", handleImageSelect);
        document
          .getElementById("request-form")
          .addEventListener("submit", handleSubmit);
        document
          .getElementById("feedback-form")
          .addEventListener("submit", handleFeedbackSubmit);

        document.querySelectorAll(".filter-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            document.querySelectorAll(".filter-tab").forEach((t) => {
              t.style.background = "transparent";
              t.style.color = "#667eea";
            });
            tab.style.background = "#667eea";
            tab.style.color = "white";

            currentFilter = tab.dataset.filter;
            renderRequests(allRequests);
          });
        });
      });

      window.removeImage = removeImage;
      window.openFeedbackModal = openFeedbackModal;
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9a4973ff702f5ded',t:'MTc2NDE2MDgxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
